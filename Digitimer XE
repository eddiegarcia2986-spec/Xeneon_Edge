<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digiclock XE v1.3.1226</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans+Condensed:wght@400;600&family=Orbitron:wght@500;700&family=Russo+One&family=Share+Tech+Mono&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style id="p1c-dynamic-styles"></style>

    <style>
        /* --- CORE STYLES --- */
        :root {
            --color-background-app: #111;
            --color-primary-main: #888;
            --font-ui: 'Fira Sans Condensed', sans-serif;
            --font-clock: 'Russo One', sans-serif;
            --radius-md: 12px;
            --base-scale: 1; 
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-aurora, var(--color-background-app)); 
            background-size: 200% 200%; 
            color: var(--color-on-background);
            font-family: var(--font-ui);
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
            transform: translateZ(0); 
            transition: background 0.8s ease, color 0.3s ease;
        }

        /* TIMER PROGRESS */
        #timer-progress {
            position: fixed; top: 0; left: 0; height: 4px;
            background: var(--color-highlight);
            width: 0%; transition: width 1s linear;
            z-index: 999; box-shadow: 0 0 10px var(--color-highlight);
        }

        .texture-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: -1;
            opacity: var(--grain-opacity, 0.05);
        }

        #app-container {
            flex: 1; display: flex; flex-direction: column;
            padding: 2vmin; gap: 2vmin;
            z-index: 1; 
        }

        /* --- CLOCK SECTION --- */
        .clock-card {
            flex: 0 0 auto;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 1vmin 0;
            border-bottom: 1px solid transparent;
            border-image: linear-gradient(90deg, transparent, var(--color-primary-variant), transparent) 1;
        }

        #time-wrapper {
            display: flex; 
            align-items: baseline; 
            justify-content: center;
            flex-wrap: nowrap;
            gap: 1.5vmin;
            line-height: 1;
        }

        #t-digits {
            font-family: var(--font-clock);
            font-size: calc(14vmin * var(--base-scale)); 
            color: var(--color-primary-main);
            text-shadow: 0 4px 20px var(--shadow-color);
        }

        .time-sidebar {
            display: flex; flex-direction: column;
            justify-content: flex-end; 
            text-align: left;
        }

        #ampm { 
            font-size: calc(4vmin * var(--base-scale)); 
            font-weight: 700; color: var(--color-highlight); 
            opacity: 0.9; margin-bottom: 0.5vmin;
        }
        
        #t-seconds { 
            font-size: calc(4vmin * var(--base-scale)); 
            font-weight: 700; 
            opacity: 0.8; 
            font-family: 'Share Tech Mono', monospace; 
            color: var(--color-primary-main);
            text-shadow: 0 0 10px var(--shadow-color);
        }

        #date-display {
            margin-top: 1vmin;
            font-size: calc(3vmin * var(--base-scale)); 
            color: var(--color-on-surface);
            opacity: 0.8;
            text-transform: uppercase;
            display: flex; align-items: center; gap: 1vmin;
        }

        /* --- UI CARDS --- */
        .tool-section {
            background: var(--color-surface-base);
            border-radius: var(--radius-md);
            padding: 2vmin;
            display: flex; flex-direction: column;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: var(--elevation-1);
            backdrop-filter: blur(15px);
        }

        .section-header {
            font-size: calc(2vmin * var(--base-scale)); 
            color: var(--color-primary-main);
            text-transform: uppercase; font-weight: bold;
            margin-bottom: 1vmin;
            display: flex; justify-content: space-between;
            cursor: pointer;
        }

        /* --- BUTTONS --- */
        .icon-btn {
            position: relative; overflow: hidden;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.05);
            color: var(--color-on-surface);
            width: 8vmin; height: 8vmin;
            border-radius: var(--radius-md);
            font-size: calc(2.5vmin * var(--base-scale)); 
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }
        .icon-btn:active { transform: scale(0.95); }

        .icon-btn.active-state { 
            background: var(--btn-primary-bg); 
            color: var(--btn-primary-text); 
            box-shadow: var(--elevation-glow);
            border-color: rgba(255,255,255,0.3);
        }

        /* --- TIMER --- */
        .timer-digits { 
            font-family: 'Share Tech Mono', monospace; 
            font-size: calc(6vmin * var(--base-scale)); 
            color: var(--color-on-surface); 
        }
        
        #timer-adjuster { 
            display: none; justify-content: center; gap: 3vmin; 
            margin-bottom: 1vmin; background: rgba(0,0,0,0.1); 
            padding: 1.5vmin; border-radius: 8px; 
        }
        .adj-col { display: flex; flex-direction: column; align-items: center; width: 6vmin; }
        .adj-btn { width: 100%; background: rgba(255,255,255,0.05); border:none; color:var(--color-highlight); padding: 0.5vmin 0; font-size: 2.5vmin; cursor: pointer; }

        /* --- ALARMS --- */
        #alarms-container { flex: 1; min-height: 0; }
        #alarm-list { flex: 1; overflow-y: auto; padding-right: 1vmin; display: flex; flex-direction: column; gap: 1vmin; }
        #alarm-list::-webkit-scrollbar { width: 4px; }
        #alarm-list::-webkit-scrollbar-thumb { background: var(--color-primary-variant); border-radius: 2px; }

        .alarm-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 1.5vmin; border-radius: 6px;
            border-left: 3px solid transparent;
        }
        .alarm-item.active { border-left-color: var(--color-highlight); background: rgba(255,255,255,0.08); }
        .ai-time { font-size: calc(3.5vmin * var(--base-scale)); font-weight: 700; font-family: var(--font-clock); color: var(--color-on-background); }
        .ai-label { font-size: 1.8vmin; opacity: 0.6; color: var(--color-highlight); }
        
        .ai-toggle {
            background: transparent; border: 1px solid rgba(255,255,255,0.3);
            color: var(--color-on-surface); padding: 0.5vmin 1.5vmin;
            border-radius: 4px; font-size: 1.8vmin; cursor: pointer; margin-right: 1vmin;
        }
        .ai-toggle.on { background: var(--color-highlight); border-color: var(--color-highlight); color: black; font-weight: bold; }
        .ai-del { background: none; border: none; color: var(--color-on-surface); font-size: 2.5vmin; cursor: pointer; opacity: 0.5; }
        .new-alarm-btn {
            background: rgba(255,255,255,0.05); color: var(--color-highlight);
            border: 1px dashed var(--color-highlight);
            width: 100%; padding: 1.5vmin; margin-top: 1vmin; border-radius: 6px;
            font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 1.8vmin;
        }

        /* --- OVERLAYS & SETTINGS FIX --- */
        .overlay {
            position: fixed; inset: 0;
            background: var(--color-background-app); opacity: 0.98;
            backdrop-filter: blur(25px); z-index: 100;
            display: none; flex-direction: column; padding: 3vmin;
        }
        .overlay.visible { display: flex; animation: fadeIn 0.2s ease-out; }
        
        .overlay-header { 
            font-size: 3vmin; color: var(--color-highlight); font-weight: bold; 
            margin-bottom: 2vmin; display: flex; justify-content: space-between;
            border-bottom: 1px solid var(--color-primary-variant); padding-bottom: 1vmin;
        }
        .close-btn { font-size: 4vmin; cursor: pointer; padding: 1vmin; line-height: 0.5; }

        /* FIX: Settings Scrollable Area */
        .settings-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 1.5vmin;
            margin-bottom: 2vmin;
        }
        .settings-scroll-area::-webkit-scrollbar { width: 4px; }
        .settings-scroll-area::-webkit-scrollbar-thumb { background: var(--color-primary-variant); border-radius: 10px; }

        .setting-group { 
            margin-bottom: 2vmin; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 1.5vmin;
        }
        .setting-group label { display: block; color: var(--color-on-surface); font-size: 1.6vmin; margin-bottom: 0.8vmin; font-weight: 600; opacity: 0.8; }
        select { width: 100%; padding: 1.8vmin; background: var(--color-surface-base); color: var(--color-on-surface); border: 1px solid var(--color-primary-variant); border-radius: 8px; font-size: 1.8vmin; outline: none; }
        
        button.action-btn { width: 100%; padding: 2vmin; border-radius: 8px; font-size: 2vmin; background: var(--color-highlight); color: black; font-weight: bold; border:none; margin-top: auto; cursor: pointer; }

        /* EDITOR UI */
        .stepper-row { display: flex; align-items: center; justify-content: center; gap: 2vmin; margin: 3vmin 0; }
        .step-col { display: flex; flex-direction: column; align-items: center; width: 15vmin; }
        .step-val { font-size: 8vmin; font-weight: bold; margin: 1vmin 0; font-variant-numeric: tabular-nums; color: var(--color-on-background); }
        .step-b { width: 100%; background: var(--color-surface-base); border: 1px solid var(--color-primary-variant); color: var(--color-on-surface); padding: 1vmin; border-radius: 4px; font-size: 3vmin; cursor: pointer; }

        /* LABELS */
        .label-grid { display: flex; flex-wrap: wrap; gap: 1vmin; margin-bottom: 2vmin; }
        .lbl-chip { padding: 1vmin 2vmin; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 1.8vmin; cursor: pointer; border: 1px solid transparent; color: var(--color-on-surface); }
        .lbl-chip.selected { background: var(--color-highlight); color: black; font-weight: bold; }

        /* RINGING */
        #ringing-overlay { background: var(--color-background-app); z-index: 200; align-items: center; justify-content: center; }
        .ringing-title { font-size: 8vmin; color: var(--color-highlight); font-weight: bold; text-align: center; animation: pulse 1s infinite; }
        
        #config-btn { position: absolute; top: 1.5vmin; right: 1.5vmin; opacity: 0.3; cursor: pointer; z-index: 50; }
        #ver-tag { position: fixed; bottom: 8px; right: 8px; opacity: 0.3; font-size: 10px; font-family: monospace; }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.98); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body onclick="AudioEngine.init()">

<div id="timer-progress"></div>
<div id="config-btn" onclick="toggleSettings()">⚙️</div>
<div id="grain-layer" class="texture-overlay"></div>

<div id="app-container">
    <div class="clock-card">
        <div id="time-wrapper">
            <div id="t-digits">12:00</div>
            <div class="time-sidebar">
                <div id="ampm">AM</div>
                <div id="t-seconds">00</div>
            </div>
        </div>
        <div id="date-display">
            <span id="date-icon">☀️</span> 
            <span id="date-text">WED | JAN 22</span>
        </div>
    </div>

    <div class="tool-section">
        <div class="section-header" onclick="toggleTimerEdit()">
            <span>TIMER</span><span style="font-size:1.5vmin; opacity:0.5">▼ EDIT</span>
        </div>
        <div id="timer-adjuster">
            <div class="adj-col"><button class="adj-btn" onclick="adjTimer('h',1)">▲</button><span style="font-size:1.2vmin">HR</span><button class="adj-btn" onclick="adjTimer('h',-1)">▼</button></div>
            <div class="adj-col"><button class="adj-btn" onclick="adjTimer('m',1)">▲</button><span style="font-size:1.2vmin">MIN</span><button class="adj-btn" onclick="adjTimer('m',-1)">▼</button></div>
            <div class="adj-col"><button class="adj-btn" onclick="adjTimer('s',1)">▲</button><span style="font-size:1.2vmin">SEC</span><button class="adj-btn" onclick="adjTimer('s',-1)">▼</button></div>
        </div>
        <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 1vmin;">
            <div class="timer-digits">
                <span id="tm-h">00</span>:<span id="tm-m">00</span>:<span id="tm-s">00</span>
            </div>
            <div style="display:flex; gap:1vmin">
                <button id="btn-t-start" class="icon-btn" style="width:auto; padding: 0 3vmin" onclick="toggleTimer()">▶</button>
                <button class="icon-btn" onclick="resetTimer()">↺</button>
            </div>
        </div>
    </div>

    <div class="tool-section" id="alarms-container">
        <div class="section-header">ALARMS</div>
        <div id="alarm-list"></div>
        <button class="new-alarm-btn" onclick="openAlarmEditor()">+ NEW ALARM</button>
    </div>
</div>

<div id="ringing-overlay" class="overlay">
    <div class="ringing-title">TIME UP</div>
    <div id="ring-label-text" style="font-size: 4vmin; margin-bottom: 5vmin; opacity: 0.8;">Timer Complete</div>
    <button class="action-btn" style="background:#ff4757; color:white; border-radius: 50px;" onclick="silenceAll()">STOP</button>
    <button class="action-btn" style="background:transparent; border:1px solid white; color:white; border-radius: 50px; margin-top:2vmin" onclick="snoozeAlarm()">SNOOZE (5m)</button>
</div>

<div id="editor-overlay" class="overlay">
    <div class="overlay-header">NEW ALARM <span class="close-btn" onclick="closeOverlay()">✕</span></div>
    <div class="stepper-row">
        <div class="step-col"><button class="step-b" onclick="adjEdit('h',1)">▲</button><div id="ed-h" class="step-val">12</div><button class="step-b" onclick="adjEdit('h',-1)">▼</button></div>
        <div style="font-size: 5vmin; opacity: 0.5;">:</div>
        <div class="step-col"><button class="step-b" onclick="adjEdit('m',1)">▲</button><div id="ed-m" class="step-val">00</div><button class="step-b" onclick="adjEdit('m',-1)">▼</button></div>
        <div class="step-col" id="ed-ampm-col"><button class="step-b" style="height: 100%; font-weight:bold" onclick="toggleEditAmpm()" id="ed-ampm">AM</button></div>
    </div>
    <div class="setting-group"><label>LABEL</label><div class="label-grid" id="label-container"></div></div>
    <div style="display:flex; gap:1vmin">
        <button class="action-btn" style="background:rgba(255,255,255,0.1); color:white" onclick="closeOverlay()">CANCEL</button>
        <button class="action-btn" onclick="saveAlarm()">SAVE</button>
    </div>
</div>

<div id="settings-overlay" class="overlay">
    <div class="overlay-header"><span>DIGICLOCK XE 1.3</span><span class="close-btn" onclick="closeOverlay()">✕</span></div>
    
    <div class="settings-scroll-area">
        <div class="setting-group"><label>Signature Preset</label><select id="set-theme" onchange="applySettings()"></select></div>
        <div class="setting-group"><label>Color Vibe (Harmony)</label><select id="set-harmony" onchange="applySettings()"></select></div>
        <div class="setting-group"><label>UI Zoom Level</label><select id="set-scale" onchange="applySettings()">
            <option value="0.8">Small (Compact)</option>
            <option value="1.0">Medium (Default)</option>
            <option value="1.2">Large (Max)</option>
        </select></div>

        <div class="setting-group"><label>OLED PixelShift</label><select id="set-safemode" onchange="applySettings()"><option value="true">Active (Drift + Breath)</option><option value="false">Off (Static)</option></select></div>
        <div class="setting-group"><label>Immersive Aurora</label><select id="set-immersive" onchange="applySettings()"><option value="true">Enabled (Mesh)</option><option value="false">Disabled (Flat)</option></select></div>
        <div class="setting-group"><label>Base Mode</label><select id="set-mode" onchange="applySettings()"><option value="dark">Dark</option><option value="light">Light</option></select></div>

        <div class="setting-group"><label>Clock Font</label><select id="set-font" onchange="applySettings()"></select></div>
        <div class="setting-group"><label>Date Format</label><select id="set-date" onchange="applySettings()"></select></div>
        <div class="setting-group"><label>Time Format</label><select id="set-fmt" onchange="applySettings()"><option value="12">12 Hour</option><option value="24">24 Hour</option></select></div>
        <div class="setting-group"><label>Timer Sound</label><select id="set-snd-timer" onchange="AudioEngine.preview('timer')"></select></div>
        <div class="setting-group"><label>Alarm Sound</label><select id="set-snd-alarm" onchange="AudioEngine.preview('alarm')"></select></div>
    </div>
    
    <button class="action-btn" onclick="closeOverlay()">CONFIRM & SAVE</button>
</div>

<div id="ver-tag">v1.3.1226 (P1C 1.2)</div>

<script>
    class P1CColorwaysEngine {
        constructor(config = {}) {
            this.config = {
                // BUG FIX: Map 'theme' to 'preset' to resolve saving issue
                preset: config.preset || config.theme || 'gunmetal',
                mode: config.mode || 'dark',
                harmony: config.harmony || 'auto',
                safeMode: config.safeMode !== false,
                immersive: config.immersive !== false,
                scale: config.scale || 1.0,
                ...config
            };

            this.presets = {
                'shadow_flames':    { seed: '#FF4500', harmony: 'analogous', label: 'Shadow & Flames' },
                'autumn_melancholy':{ seed: '#D65518', harmony: 'analogous', label: 'Autumn Melancholy' },
                'saffron_spice':    { seed: '#F4C430', harmony: 'triadic', label: 'Saffron Spice' },
                'lost_forest':      { seed: '#00FF7F', harmony: 'split-complementary', label: 'Lost in a Forest' },
                'aquarian_feels':   { seed: '#00BFFF', harmony: 'analogous', label: 'Aquarian Feels' },
                'space_coast':      { seed: '#4169E1', harmony: 'monochromatic', label: 'Space Coast' },
                'steel_dont_burn':  { seed: '#B0C4DE', harmony: 'monochromatic', label: 'Steel Don’t Burn' },
                'drink_toxicity':   { seed: '#9400D3', harmony: 'triadic', label: 'Drink Toxicity' },
                'the_raven':        { seed: '#4B0082', harmony: 'analogous', label: 'The Raven' },
                'blooming_sakuras': { seed: '#FF69B4', harmony: 'split-complementary', label: 'Blooming Sakuras' },
                'neon_stockings':   { seed: '#FF00FF', harmony: 'tetradic', label: 'Neon Stockings' },
                'i_need_coffee':    { seed: '#8B4513', harmony: 'analogous', label: 'I Need Coffee' },
                'caramel_drizzle':  { seed: '#D2691E', harmony: 'split-complementary', label: 'Caramel Drizzle' },
                'midnight_shuteyes':{ seed: '#191970', harmony: 'monochromatic', label: 'Midnight Shuteyes' },
                'ghosty_fear':      { seed: '#F8F8FF', harmony: 'monochromatic', label: 'Ghosty Fear' },
                'oil_slick':        { seed: '#2F4F4F', harmony: 'analogous', label: 'Oil Slick' },
                'gunmetal':         { seed: '#2A3439', harmony: 'monochromatic', label: 'Gunmetal' },
                'obsidian_storm':   { seed: '#36454F', harmony: 'split-complementary', label: 'Obsidian Storm' }
            };

            // Safeguard against deleted/invalid presets
            const p = this.presets[this.config.preset] || this.presets['gunmetal'];
            this.config.seed = p.seed;
            if(this.config.harmony === 'auto') this.config.harmony = p.harmony;

            this.tokens = {}; this.cssKeyframes = ''; 
        }

        generate() {
            const baseHue = this.hexToHue(this.config.seed);
            const harmonies = this.generateHarmonies(baseHue);
            let dynamicHues = { ...harmonies };

            if (this.config.safeMode) {
                this.cssKeyframes += this.generatePixelShiftCSS();
                Object.keys(dynamicHues).forEach(k => { dynamicHues[k] = `calc(${harmonies[k]} + var(--ps-drift))`; });
            }

            const pScale = this.generateTonalScale(dynamicHues.primary);
            const sScale = this.generateTonalScale(dynamicHues.secondary);
            const nScale = this.generateTonalScale(dynamicHues.primary, 0.02);

            const isDark = this.config.mode === 'dark';
            const op = this.config.safeMode ? 'var(--ps-breath)' : '1';

            this.tokens = {
                '--base-scale': this.config.scale,
                '--color-primary-main': isDark ? pScale[400] : pScale[600],
                '--color-primary-variant': isDark ? pScale[600] : pScale[400],
                '--color-background-app': isDark ? nScale[950] : nScale[50],
                '--color-surface-base': isDark ? `rgba(20,20,20, 0.6)` : `rgba(255,255,255, 0.6)`,
                '--color-on-background': `rgba(${isDark ? '255,255,255' : '0,0,0'}, ${op})`,
                '--color-on-surface': `rgba(${isDark ? '255,255,255' : '0,0,0'}, 0.8)`,
                '--color-highlight': sScale[400],
                '--btn-primary-bg': sScale[400],
                '--btn-primary-text': '#000',
                '--grain-opacity': '0.07',
                '--shadow-color': isDark ? 'rgba(0,0,0,0.8)' : 'rgba(0,0,0,0.2)'
            };

            if (this.config.immersive) {
                const c1 = `hsla(${harmonies.primary}, 70%, 50%, 0.4)`;
                const c2 = `hsla(${harmonies.secondary}, 70%, 50%, 0.4)`;
                this.tokens['--bg-aurora'] = `radial-gradient(circle at 0% 0%, ${c1} 0%, transparent 50%), radial-gradient(circle at 100% 100%, ${c2} 0%, transparent 50%), ${this.tokens['--color-background-app']}`;
                this.tokens['--elevation-glow'] = `0 0 25px oklch(0.6 0.2 ${harmonies.primary} / 0.4)`;
            }

            this.cssKeyframes += `.texture-overlay { background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }`;

            return { tokens: this.tokens, globalCSS: this.cssKeyframes };
        }

        generateHarmonies(hue) {
            const h = {
                'monochromatic': { primary: hue, secondary: hue, tertiary: hue },
                'analogous': { primary: hue, secondary: (hue + 30) % 360, tertiary: (hue - 30) % 360 },
                'split-complementary': { primary: hue, secondary: (hue + 150) % 360, tertiary: (hue + 210) % 360 },
                'triadic': { primary: hue, secondary: (hue + 120) % 360, tertiary: (hue + 240) % 360 },
                'tetradic': { primary: hue, secondary: (hue + 90) % 360, tertiary: (hue + 180) % 360 }
            };
            return h[this.config.harmony] || h['monochromatic'];
        }

        generateTonalScale(hue, chroma = 0.14) {
            return {
                50: `oklch(0.95 ${chroma} ${hue})`,
                400: `oklch(0.6 ${chroma} ${hue})`,
                600: `oklch(0.4 ${chroma} ${hue})`,
                950: `oklch(0.1 ${chroma} ${hue})`
            };
        }

        generatePixelShiftCSS() {
            return `@property --ps-drift { syntax: '<number>'; inherits: true; initial-value: 0; } @property --ps-breath { syntax: '<number>'; inherits: true; initial-value: 1; } :root { animation: ps-drift 1800s infinite linear, ps-breath 60s infinite ease-in-out; } @keyframes ps-drift { 0%, 100% { --ps-drift: 0; } 50% { --ps-drift: 15; } } @keyframes ps-breath { 0%, 100% { --ps-breath: 0.95; } 50% { --ps-breath: 0.8; } }`;
        }

        hexToHue(H) {
            if(!H) return 0;
            let r = parseInt(H.slice(1,3), 16)/255, g = parseInt(H.slice(3,5), 16)/255, b = parseInt(H.slice(5,7), 16)/255;
            let max = Math.max(r,g,b), min = Math.min(r,g,b), d = max - min, h;
            if (d==0) h=0; else if (max==r) h=((g-b)/d)%6; else if (max==g) h=(b-r)/d+2; else h=(r-g)/d+4;
            h = Math.round(h*60); return h < 0 ? h+360 : h;
        }
    }

    const AudioEngine = {
        ctx: null,
        init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
        play(name) {
            this.init(); const t = this.ctx.currentTime; const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.connect(g); g.connect(this.ctx.destination);
            o.type = name.includes('Digital') ? 'square' : 'sine';
            o.frequency.setValueAtTime(name.includes('Alert') ? 800 : 440, t);
            g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.5);
            o.start(); o.stop(t+0.5);
        },
        preview(type) { this.play(document.getElementById(type === 'timer' ? 'set-snd-timer' : 'set-snd-alarm').value); }
    };

    const fonts = ["Russo One", "Orbitron", "Fira Sans Condensed", "Share Tech Mono", "Roboto"];
    const dateFormats = [{id:'full', l:'Wed | January 10'}, {id:'short', l:'Wed | Jan 10'}, {id:'minimal', l:'Jan 10'}];
    const soundList = ["Beep", "Double Beep", "Digital Alarm", "Sci-Fi Warp", "Red Alert"];
    
    let state = {
        theme: 'gunmetal', safeMode: 'true', immersive: 'true', mode: 'dark',
        harmony: 'auto', scale: '1.0', font: 'Russo One', fmt: '12', dateFmt: 'full',
        sndTimer: 'Beep', sndAlarm: 'Digital Alarm', alarms: []
    };
    
    let timer = { h:0, m:0, s:0, running:false, endTime:0, total:0 };
    let editor = { h:12, m:0, label:'Work' };
    let ringing = { active: false, interval: null };

    function init() {
        const saved = localStorage.getItem('xen_digitimer_v1.3');
        if(saved) state = { ...state, ...JSON.parse(saved) };

        const fill = (id, data, val) => {
            const el = document.getElementById(id); el.innerHTML = '';
            data.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id || item; opt.innerText = item.l || item;
                if(opt.value === String(val)) opt.selected = true;
                el.appendChild(opt);
            });
        };

        fill('set-font', fonts, state.font);
        fill('set-date', dateFormats, state.dateFmt);
        fill('set-snd-timer', soundList, state.sndTimer);
        fill('set-snd-alarm', soundList, state.sndAlarm);
        fill('set-harmony', ['auto', 'monochromatic', 'analogous', 'split-complementary', 'triadic', 'tetradic'], state.harmony);

        const engine = new P1CColorwaysEngine();
        const tSel = document.getElementById('set-theme');
        Object.keys(engine.presets).forEach(k => {
            const opt = document.createElement('option'); opt.value = k; opt.innerText = engine.presets[k].label;
            if(k === state.theme) opt.selected = true;
            tSel.appendChild(opt);
        });

        document.getElementById('set-scale').value = state.scale;
        document.getElementById('set-safemode').value = String(state.safeMode);
        document.getElementById('set-immersive').value = String(state.immersive);
        document.getElementById('set-mode').value = state.mode;
        document.getElementById('set-fmt').value = state.fmt;

        applySettings();
        renderAlarms();
        setInterval(tick, 250); 
    }

    function applySettings() {
        state.theme = document.getElementById('set-theme').value;
        state.harmony = document.getElementById('set-harmony').value;
        state.scale = document.getElementById('set-scale').value;
        state.safeMode = document.getElementById('set-safemode').value === 'true';
        state.immersive = document.getElementById('set-immersive').value === 'true';
        state.mode = document.getElementById('set-mode').value;
        state.font = document.getElementById('set-font').value;
        state.dateFmt = document.getElementById('set-date').value;
        state.fmt = document.getElementById('set-fmt').value;
        state.sndTimer = document.getElementById('set-snd-timer').value;
        state.sndAlarm = document.getElementById('set-snd-alarm').value;

        // Re-generate engine with new state
        const engine = new P1CColorwaysEngine(state);
        const res = engine.generate();
        
        Object.keys(res.tokens).forEach(k => document.documentElement.style.setProperty(k, res.tokens[k]));
        document.getElementById('p1c-dynamic-styles').innerHTML = res.globalCSS;
        document.documentElement.style.setProperty('--font-clock', state.font);

        localStorage.setItem('xen_digitimer_v1.3', JSON.stringify(state));
        renderAlarms();
    }

    function tick() {
        const now = new Date();
        const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();

        let disH = h;
        let am = state.fmt === '12' ? (h >= 12 ? "PM" : "AM") : "";
        if(state.fmt === '12') disH = h % 12 || 12;

        document.getElementById('t-digits').innerText = `${String(disH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        document.getElementById('ampm').innerText = am;
        document.getElementById('t-seconds').innerText = String(s).padStart(2,'0');

        const opts = { full: {weekday:'short', month:'long', day:'numeric'}, short: {weekday:'short', month:'short', day:'numeric'}, minimal: {month:'short', day:'numeric'} }[state.dateFmt];
        document.getElementById('date-text').innerText = now.toLocaleDateString('en-US', opts).toUpperCase();

        state.alarms.forEach((a, i) => {
            if(a.active && a.h === h && a.m === m && s === 0) {
                startRinging(a.label, 'alarm');
                state.alarms[i].active = false;
                renderAlarms();
            }
        });

        if(timer.running) {
            const rem = Math.max(0, timer.endTime - Date.now());
            const pct = (rem / timer.total) * 100;
            document.getElementById('timer-progress').style.width = pct + '%';
            if(rem === 0) { timer.running = false; startRinging("Timer Complete", 'timer'); resetTimer(); }
            const sec = Math.ceil(rem / 1000);
            document.getElementById('tm-h').innerText = String(Math.floor(sec/3600)).padStart(2,'0');
            document.getElementById('tm-m').innerText = String(Math.floor((sec%3600)/60)).padStart(2,'0');
            document.getElementById('tm-s').innerText = String(sec%60).padStart(2,'0');
        }
    }

    function toggleTimer() {
        if(timer.running) { timer.running = false; document.getElementById('btn-t-start').innerText = "▶"; }
        else {
            const ms = (parseInt(document.getElementById('tm-h').innerText)*3600 + parseInt(document.getElementById('tm-m').innerText)*60 + parseInt(document.getElementById('tm-s').innerText)) * 1000;
            if(ms <= 0) return;
            timer.total = ms; timer.endTime = Date.now() + ms; timer.running = true;
            document.getElementById('btn-t-start').innerText = "||";
        }
    }

    function resetTimer() { timer.running = false; document.getElementById('tm-h').innerText="00"; document.getElementById('tm-m').innerText="00"; document.getElementById('tm-s').innerText="00"; document.getElementById('timer-progress').style.width='0%'; document.getElementById('btn-t-start').innerText="▶"; }
    function adjTimer(u,d) { if(timer.running) return; const el = document.getElementById(`tm-${u}`); let v = parseInt(el.innerText)+d; if(v<0) v=0; el.innerText = String(v).padStart(2,'0'); }
    function toggleTimerEdit() { const s = document.getElementById('timer-adjuster').style; s.display = s.display === 'flex' ? 'none' : 'flex'; }

    function openAlarmEditor() { 
        const d = new Date(); editor.h = d.getHours(); editor.m = d.getMinutes(); 
        drawEdit(); renderLabels(); document.getElementById('editor-overlay').classList.add('visible'); 
    }
    function adjEdit(u,d) { if(u==='h') editor.h=(editor.h+d+24)%24; else editor.m=(editor.m+d+60)%60; drawEdit(); }
    function toggleEditAmpm() { editor.h = (editor.h+12)%24; drawEdit(); }
    function drawEdit() { 
        let h = editor.h; let am = state.fmt==='12' ? (h>=12?"PM":"AM") : "";
        if(state.fmt==='12') h = h%12||12;
        document.getElementById('ed-h').innerText = String(h).padStart(2,'0');
        document.getElementById('ed-m').innerText = String(editor.m).padStart(2,'0');
        document.getElementById('ed-ampm').innerText = am;
        document.getElementById('ed-ampm-col').style.display = state.fmt==='12'?'flex':'none';
    }
    function renderLabels() {
        const c = document.getElementById('label-container'); c.innerHTML = '';
        ["Work", "Game", "Nap", "Food"].forEach(l => {
            const d = document.createElement('div'); d.className=`lbl-chip ${editor.label===l?'selected':''}`;
            d.innerText=l; d.onclick=()=>{editor.label=l; renderLabels();}; c.appendChild(d);
        });
    }
    function saveAlarm() { state.alarms.push({h:editor.h, m:editor.m, label:editor.label, active:true}); applySettings(); closeOverlay(); }
    function renderAlarms() {
        const l = document.getElementById('alarm-list'); l.innerHTML = '';
        state.alarms.forEach((a, i) => {
            const d = document.createElement('div'); d.className = `alarm-item ${a.active?'active':''}`;
            let h = a.h; let am = state.fmt==='12'?(h>=12?'PM':'AM'):''; if(state.fmt==='12') h=h%12||12;
            d.innerHTML = `<div><div class="ai-time">${String(h).padStart(2,'0')}:${String(a.m).padStart(2,'0')} ${am}</div><div class="ai-label">${a.label}</div></div><button class="ai-del" onclick="state.alarms.splice(${i},1);applySettings()">✕</button>`;
            l.appendChild(d);
        });
    }

    function startRinging(l, t) {
        ringing.active = true; document.getElementById('ringing-overlay').classList.add('visible');
        document.getElementById('ring-label-text').innerText = l;
        const s = t === 'alarm' ? state.sndAlarm : state.sndTimer;
        AudioEngine.play(s); ringing.interval = setInterval(()=>AudioEngine.play(s), 2000);
    }
    function silenceAll() { ringing.active = false; clearInterval(ringing.interval); document.getElementById('ringing-overlay').classList.remove('visible'); }
    function snoozeAlarm() { silenceAll(); const n = new Date(); n.setMinutes(n.getMinutes()+5); state.alarms.push({h:n.getHours(), m:n.getMinutes(), label:'Snooze', active:true}); applySettings(); }

    function toggleSettings() { document.getElementById('settings-overlay').classList.toggle('visible'); }
    function closeOverlay() { document.querySelectorAll('.overlay').forEach(e => e.classList.remove('visible')); }

    init();
</script>
</body>
</html>
